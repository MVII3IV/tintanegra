<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Estado de Pedido</title>

    <link rel="stylesheet" href="assets/css/bootstrap.rtl.min.css" />
    <link rel="stylesheet" href="assets/css/swiper-bundle.min.css" />
    <link rel="stylesheet" href="assets/css/scrollCue.css" />
    <link rel="stylesheet" href="assets/css/boxicons.min.css" />
    <link rel="stylesheet" href="assets/fonts/flaticon_pozu.css" />
    <link rel="stylesheet" href="assets/css/navbar.css" />
    <link rel="stylesheet" href="assets/css/footer.css" />
    <link rel="stylesheet" href="assets/css/style.css" />
    <link rel="stylesheet" href="assets/css/responsive.css" />
    <link rel="stylesheet" href="assets/css/rtl.css" />
    <link rel="stylesheet" href="assets/css/orders.css" />
    <script src="assets/js/swiper-bundle.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>

     
  </head>
  <body>
    <div class="pedido-container">
      <div class="pedido-header text-center">
        <h2>Detalles de tu Pedido</h2>
        <p id="pedido-nombre" class="pedido-subtitle mb-0"></p>
      </div>

      <div class="swiper mySwiper">
        <div class="swiper-wrapper" id="pedido-imagenes"></div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>

      <!-- Nuevo div para el botón "Ver paleta de colores" -->
      <div class="d-flex justify-content-center mt-3 mb-4"> 
        <button class="btn btn-primary btn-sm btn-palette" data-bs-toggle="modal" data-bs-target="#modalPaleta">
          <i class="bx bx-palette me-1"></i> Ver paleta de colores
        </button>
      </div>
      <!-- Fin del nuevo div -->

      <div class="pedido-timeline mt-4">
        <ul class="timeline-list d-flex justify-content-between list-unstyled px-0 mb-0">
          <li class="timeline-item text-center">
            <div class="timeline-circle"><i class="bx bx-receipt"></i></div>
            <div class="timeline-label">Recibida</div>
          </li>
          <li class="timeline-item text-center">
            <div class="timeline-circle"><i class="bx bx-dollar"></i></div>
            <div class="timeline-label">Anticipo Recibido</div>
          </li>
          <li class="timeline-item text-center">
            <div class="timeline-circle"><i class="bx bx-cog"></i></div>
            <div class="timeline-label">En Producción</div>
          </li>
          <li class="timeline-item text-center">
            <div class="timeline-circle"><i class="bx bx-check-double"></i></div>
            <div class="timeline-label">Finalizada</div>
          </li>
          <li class="timeline-item text-center">
            <div class="timeline-circle"><i class="bx bx-package"></i></div>
            <div class="timeline-label">Entregada</div>
          </li>
        </ul>
      </div>

      <div class="row g-4">
        <div class="col-md-6">
          <div class="card-soft h-100 p-3">
            <div class="section-title mb-3 text-center">Detalles de Entrega</div>
            <span class="text-center d-block mb-3">Aqui encontraras informacion de recepcion y entrega de tu pedido</span>
            <div class="d-flex justify-content-center gap-3 mb-2">
              <span class="badge bg-primary d-flex align-items-center">
                <i class="bx bx-time-five me-1"></i>
                Inicio: <span id="pedido-fecha-inicio" class="ms-1"></span>
              </span>
              <span class="badge bg-primary d-flex align-items-center">
                <i class="bx bx-calendar-check me-1"></i>
                Entrega: <span id="pedido-fecha-entrega" class="ms-1"></span>
              </span>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="card-soft h-100">
            <div class="section-title">Detalles de Pago</div>
            <div class="d-flex justify-content-between">
              <span>Costo total</span><strong id="pedido-costo"></strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Anticipo</span><strong id="pedido-anticipo"></strong>
            </div>
            <div class="d-flex justify-content-between">
              <span>Restante</span><strong id="pedido-restante"></strong>
            </div>
            <div class="progress mt-3" role="progressbar" aria-label="Progreso de pago">
              <div id="barra-pago" class="progress-bar" style="width: 0%"></div>
            </div>
          </div>
        </div>

        <div class="col-12">
          <div class="card-soft">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
              <div class="section-title mb-0">Tallas y Colores</div>
              <!-- El botón se ha movido, así que lo eliminamos de aquí -->
            </div>
            <div class="table-responsive mt-3">
              <table class="table table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>Talla</th>
                    <th>Cantidad</th>
                    <th>Color</th>
                  </tr>
                </thead>
                <tbody id="pedido-tallas"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div class="modal fade" id="modalPaleta" tabindex="-1" aria-labelledby="modalPaletaLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalPaletaLabel">Paleta de Colores</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body text-center">
          <!-- Imagen dinámica -->
          <img id="pedido-paleta" src="" alt="Paleta de colores" class="img-fluid rounded-3" />
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

    
    <script>
      const estados = ["Recibida","Anticipo recibido","En produccion","Finalizada","Entregada"];

      const fmtMoney = (n) => typeof n === "number" ? n.toLocaleString("es-MX",{style:"currency",currency:"MXN"}) : n;

      const params = new URLSearchParams(window.location.search);
      const pedidoId = params.get("id");
      const container = document.querySelector(".pedido-container");

      if (!pedidoId) {
        container.innerHTML = '<h3 class="text-center text-danger">ID de pedido no proporcionado</h3>';
      } else {
        fetch(`getOrderDetails.php?id=${pedidoId}`)
        .then(res => res.json())
        .then(data => {
          if(!data.success || !data.pedido){
            container.innerHTML = `<h3 class="text-center text-danger">No se encontró el pedido</h3>`;
            return;
          }

          const pedido = data.pedido;

          document.getElementById("pedido-nombre").textContent = pedido.nombre;
          document.getElementById("pedido-fecha-inicio").textContent = pedido.fechaInicio;
          document.getElementById("pedido-fecha-entrega").textContent = pedido.fechaEntrega;

          const paletaImg = document.getElementById("pedido-paleta");
          if (pedido.paletaColor) {
            paletaImg.src = pedido.paletaColor;
            paletaImg.style.display = "block";
          } else {
            paletaImg.style.display = "none"; // Si no hay paleta, se oculta
          }

          document.querySelectorAll(".timeline-item").forEach((item,index)=>{
            const estadoActualIndex = estados.indexOf(pedido.status);
            if(index <= estadoActualIndex) item.classList.add("completed");
          });

          const restante = Math.max(0,(pedido.costo||0)-(pedido.anticipo||0));
          document.getElementById("pedido-costo").textContent = fmtMoney(pedido.costo||0);
          document.getElementById("pedido-anticipo").textContent = fmtMoney(pedido.anticipo||0);
          document.getElementById("pedido-restante").textContent = fmtMoney(restante);
          const pct = pedido.costo ? Math.min(100,Math.round((pedido.anticipo/pedido.costo)*100)) : 0;
          document.getElementById("barra-pago").style.width = pct+"%";

          const tbody = document.getElementById("pedido-tallas");
          tbody.innerHTML = "";
          (pedido.tallas||[]).forEach(t => {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td>${t.talla}</td><td>${t.cantidad}</td><td><span class="color-chip" style="background:${t.color}"></span></td>`;
            tbody.appendChild(tr);
          });

          const wrap = document.getElementById("pedido-imagenes");
          wrap.innerHTML = "";
          (pedido.imagenes||[]).forEach(src=>{
            const slide = document.createElement("div");
            slide.className="swiper-slide";
            slide.innerHTML=`<img src="${src}" alt="Imagen del pedido">`;
            wrap.appendChild(slide);
          });

          new Swiper(".mySwiper",{
            loop:true,
            pagination:{el:".swiper-pagination",clickable:true},
            navigation:{nextEl:".swiper-button-next",prevEl:".swiper-button-prev"}
          });
        })
        .catch(err=>{
          container.innerHTML='<h3 class="text-center text-danger">Error cargando pedido</h3>';
          console.error(err);
        });
      }
    </script>
  </body>
</html>